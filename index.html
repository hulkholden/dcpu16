<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="bootstrap.min.css">

    <title>DCPU-16 Emulator</title>
  </head>
  <body>
    <div class="container" id="container">
      <div class="row">
        <div class="span12">
          <h1><a href="http://0x10c.com/doc/dcpu-16.txt">DCPU-16</a> Emulator for <a href="http://0x10c.com/">0x10c</a></h1>
        </div>
      </div>

      <div class="row">
        <div class="span12">
          <div id="form">
            <form action='javascript:doExecute()'>
              <fieldset>
                <div class="control-group">
                  <label class="control-label" for="codearea">Code</label>
                  <div class="controls">
                    <textarea class="input-xxlarge" id="codearea" rows=8>
; Try some basic stuff
              SET A, 0x30              ; 7c01 0030
              SET [0x1000], 0x20       ; 7de1 1000 0020
              SUB A, [0x1000]          ; 7803 1000
              IFN A, 0x10              ; c00d 
                 SET PC, crash         ; 7dc1 001a [*]
              
; Do a loopy thing
              SET I, 10                ; a861
              SET A, 0x2000            ; 7c01 2000
:loop         SET [0x2000+I], [A]      ; 2161 2000
              SUB I, 1                 ; 8463
              IFN I, 0                 ; 806d
                 SET PC, loop          ; 7dc1 000d [*]

; Call a subroutine
              SET X, 0x4               ; 9031
              JSR testsub              ; 7c10 0018 [*]
              SET PC, crash            ; 7dc1 001a [*]

:testsub      SHL X, 4                 ; 9037
              SET PC, POP              ; 61c1
                
; Hang forever. X should now be 0x40 if everything went right.
:crash        SET PC, crash            ; 7dc1 001a [*]

; [*]: Note that these can be one word shorter and one cycle faster by using the short form (0x00-0x1f) of literals,
;      but my assembler doesn't support short form labels yet.
                    </textarea>
                  </div>
                </div>
                <!--
                <div class="control-label" class="control-group">
                  <label for="fileInput">Filename</label>
                  <div class="controls">
                    <input class="input-file" id="fileInput" name="fileInput" type="file" />
                  </div>
                </div>
                -->
                <div class="form-actions">
                  <!-- input type="submit" class="btn btn-primary" value="Load">&nbsp;-->
                  <button class="btn" onclick="load()">Load</button>&nbsp;
                  <button class="btn" onclick="reset()">Reset</button>&nbsp;
                  <button class="btn" onclick="step()">Step</button>&nbsp;
                  <button class="btn btn-primary" onclick="run()">Run</button>&nbsp;
                </div>
              </fieldset>
            </form>  
          </div>
        </div>
      </div>

      <div class="row">
        <div class="span12">
          <div id="registers"></div>
          <div id="disasm"></div>
          <div id="output"></div>
        </div>
      </div>

    </div>
    <script src="jquery-1.6.4.min.js"></script>
    <script src="dcpu16.js"></script>

    <script>

    var dcpu = DCPU16();
    var puter = dcpu.makePuter();

    // Load state from localStorage
    var prev_code = localStorage.getItem('code');
    if (prev_code) {
      $('#codearea').val(prev_code);
      gProgram = dcpu.parseSource(prev_code);
    }

    load();

    function doExecute() {
      var f = document.getElementById("fileInput");
      if (f && f.files.length > 0) {
        var file = f.files[0];
        var name = file.fileName;
        var size = file.fileSize;

        var reader = new FileReader();

        reader.onerror = function(e) {
          alert('error');
        }

        // Closure to capture the file information.
        reader.onload = function(e) {
            //puter.setName(name);
            gProgram = e.target.result;
            reset();
        };

        // Read in the image file as a data URL.
        reader.readAsArrayBuffer(file);
      }
    }

    function load() {
      var t = $('#codearea').val();
      localStorage.setItem('code', t);
      gProgram = dcpu.parseSource(t);
      reset();
    }

    function reset() {
      // reload program state
      puter.loadCode(gProgram);
      dcpu.displayDisassembly(gProgram, puter.PC);
      dcpu.displayState(puter);
    }

    function step() {
      puter.run(1);
      dcpu.displayDisassembly(gProgram, puter.PC);
      dcpu.displayState(puter);
    }

    function run() {
      puter.run(10000);
      dcpu.displayDisassembly(gProgram, puter.PC);
      dcpu.displayState(puter);
    }

    </script>

  </body>
</html>
